## 스프링 DB 접근 기술

### H2 데이터 베이스 설치

```sql
# 테이블 생성
create table member
(
 id bigint generated by default as identity,
 name varchar(255),
 primary key (id)
);
# 값 넣기
insert into member(name) values('spring')
```

### 순수 JDBC

- 환경설정

```
// build.gradle 파일에 관련된 라이브러리 추가
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'

//resources/application.properties 파일에 스프링 부트 데이터베이스 연결 설정 추가
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa

```

- jdbc 리포지토리 구현 (참고만)
- 스프링 설정 변경
  - DataSource는 데이터 베이스 커넥션을 획득할 때 사용하는 객체이다.

```java
    @Configuration
    public class SpringConfig {
        private final DataSource dataSource;

        @Autowired
        public SpringConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }
        @Bean
        public MemberService memberService() {
        return new MemberService(memberRepository());
    }
        @Bean
        public MemberRepository memberRepository() {
     // return new MemoryMemberRepository();
        return new JdbcMemberRepository(dataSource);
 }
}

```

- OCP 개방 폐쇄 원칙 : 확장에는 열려있고, 수정, 변경에는 닫혀 있다.

### 스프링 통합 테스트

- `@SpringBootTest` : 스프링 컨테이너와 테스트를 함께 실행한다.
- `@Transactional` :(테스트케이스에 붙었을 때만) 테스트 시작 전에 트랜잭션을 시작하고 테스트가 끝나면 롤백한다. (DB에 데이터를 남기지 않기 위해)
- 테스트 케이스에서는 다른 곳에서 가져다 쓰지 않기 때문에 필드 선언을 하면 편하다.

```java
    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository
```

### 스프링 JdbcTemplate

- JdbcTemplate 과 myBatis같은 라이브러리는 JDBC API에서 본 반복 코드를 대부분 제거해주지만 쿼리문은 직접 작성해야한다.
- 빈에 등록된 상태에서 생성자가 1개이면 `@Autowired` 생략 가능하다.
- RowMapper 인터페이스 : row 단위로 ResultSet의 row을 매핑하기 위해 JdbcTemplate에서 사용하는 인터페이스이다.

```java
   @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(),id);
        //쿼리문과 맵퍼 전달
        return result.stream().findAny();
    }
```

- SimpleJdbcInsert : 인서트문을 만들어줌

### JPA

- JPA를 사용하면 쿼리문을 작성해준다.
- JPA를 사용하면 데이터 중심 설계에서 객체 중심 설계로 패러다임을 전환 할 수 있다.
- 환경 설정

```
// in build.gradle
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
//내부에 jdbc 관련 라이브러리가 포함되어 있음

//in resources/application.properties
spring.jpa.show-sql=true // JPA가 생성하는 sql 문 출력
spring.jpa.hibernate.ddl-auto=none  //테이블을 자동생성하는 기능 끈다. create가 기본값

```

-`@Entity` : JPA가 관리하는 엔티티

- `@Id` : pk
- `@GeneratedValue(strategy = GenerationType.IDENTITY)` : 아이디 자동 생성
- `@Column(name="username")` : username과 매핑
- 위에서 그레이들 설정을 하면 스프링 부트가 자동으로 엔티티 매니저 생성
- `em.createQuery("select m from Member m",Member.class)`
  - jpql이라는 쿼리 언어이다.
  - 엔티티 대상으로 쿼리를 날린다. sql로 번역이 된다.
- service 레벨에서 `@Transaction` 작성

### 스프링 데이터 JPA

- 인터페이스만으로 개발이 가능하다.
- 앞 JPA 설정과 환경 설정이 같다.
- JpaRepository 인터페이스를 상속받은 인터페이스 생성

```java

public interface SpringDataJpaMemberRepository extends JpaRepository<Member,Long> , MemberRepository{ //<엔티티,pk 아이디 타입>
    @Override
    Optional<Member> findByName(String name);
}

```

- JpaRepository를 상속받고 있으면 인터페이스를 자동으로 구현해준다.
  - 스프링 빈에 자동으로 등록해준다.

```

@Configuration
public class SpringConfig {

    private final MemberRepository memberRepository;

    public SpringConfig(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    @Bean
    public MemberService memberService(){
     return new MemberService(memberRepository);
    }
}
```

- crud와 여러 기능들 제공한다.

```
    Optional<Member> findByName(String name);
    //JPQL select m from Member m where m.name=? 으로 변환한다.
    //인터페이스 이름만으로도 쿼리문을 작성할 수 있다.
```

- 동적쿼리는 Querydsl라는 라이브러리를 사용한다.
