## 🐻 H2 데이터베이스 설치

- [설치 링크](https://h2database.com/html/main.html)
- JDBC URL을 `jdbc:h2:tcp://localhost/~/test`으로 변경 : 소켓을 통해서 접근
- `org.h2.jdbc.JdbcSQLNonTransientConnectionException`
  - home 경로에 `test.mv.db` 파일 만들기
- `generated by default as indentity` : Null 값일때 DB가 값 자동으로 채움
- 프로젝트 폴더 내에서 따로 디렉토리를 파서 쿼리문 관리하면 편함

## 🐻 순수 JDBC

- build.gradle 파일에 관련 라이브러리 추가
- `javax.sql.DataSource`를 스프링에게 주입받아야함

```java
private DataSource dataSource;

public class Repository(DataSource dataSource) {
    this.dataSource = dataSource;
}

public Object save(Object object) {
    String sql = "insert into object(value) values(?)";

    Connection connection = dataSource.getConnection();
    PreparedStatement pstmt = conn.prepareStatement(sql);
    // 자동 생성된 id 값을 가져오고 싶다면?
    // PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATE_KEYS);

    pstmt.setString(1, object.getName());

    pstmt.excuteUpdate();
}

public Object get(Object object) {
    Connection connection = dataSource.getConnection();
    PreparedStatement pstmt = conn.prepareStatement(sql);

    pstmt.executeQuery();
    rs = pstmt.getGeneratedKeys();

    if (rs.next()) {
        ...
    }
}
```

- `Config`에 `DataSource` 인스턴스 변수와 `repository()`에 등록된 빈 변경
- 개방-폐쇄 원칙(OCP, Open-Closed Principle) : 확장에는 열려있고, 변경(수정)에는 닫혀있다.
  - 기존 코드 수정 없이 **설정 변경만으로 구현 클래스 변경 가능**

## 🐻 스프링 통합 테스트

```java
@SpringBootTest
@Transactional
class ServiceIntegrationTest {
    @Autowired Service service;
    @Autowired Repository repository;
}
```

- `@SpringBootTest` : 스프링 컨테이너와 테스트 함께 실행
- `@Transactional`
  - 테스트는 반복할 수 있어야 한다.
  - 이전 테스트 데이터가 DB에 저장되어 있으면 반복 불가
  - 트랜잭션을 실행해서 쿼리를 실행하고 롤백
  - 결과적으로 테스트가 DB에 반영 안됨

## 🐻 스프링 JdbcTemplate

- JdbcTemplate, MyBatis 같은 라이브러리로 반복 코드를 대부분 제거
  - 쿼리문은 직접 작성

```java
public class Repository {
    private final JdbcTemplate jdbcTemplate;

    @Autowired // 생략 가능
    public Repository(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

    public Optional<Object> find() {
        List<Obejct> result = jdbcTemplate.query("select * from object", rowMapper());
        return result.stream.findAny();
    }

    private RowMapper<Object> rowMapper() {
        return (rs, rowNum) -> {
            Object object = new Object();
            // setter로 객체 데이터 저장
            return object;
        };
    }
}
```

## 🐻 JPA

- build.gradle에 dependency 추가, application.properties 설정
- JPA는 Java 진영의 표준 인터페이스
  - 구현 : Hibernate, Eclipse Link ...

```java
@Entity
public class Domain {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long int;
}
```

- `@Entity`
- `@Id` : Primary Key
- `@GeneratedValue` : 자동 생성 값 저장
  - `GenerationType.IDENTITY` : DB 자동 생성

```java
public class Repository {
    private final EntityManager em;

    public Domain save(Domain object) {
        em.persist(object);
        return object;
    }

    public Domain find(Long id) {
        return em.find(Domain.class, id);
    }

    public Optional<Domain> findByValue(String value) {
        // select m from Member m where m.name = :name", Member.class)
        return em.createQuery("query", Comain.class)
                .setParameter("value", value)
                .getResultList()
                .stream()
                .findAny();
    }

    public List<Domain> findAll() {
        // select m from Member m
        return em.createQuery("query", Domain.class).getResultList();
    }
}
```

```java
@Transactional
public class Service {
    ...
}
```

## 🐻 스프링 데이터 JPA

- 스프링 JPA가 자동으로 구현체 등록
- 기본적인 CRUD, 단순 조회 제공

```java
@Configuration
public class Config {
    private final Repository repository;

    @Autowired
    public Config(Repository repository) {
        this.repository = repository;
    }

    @Bean
    public Service Service() {
        return new Service(repository);
    }
}

public interface Repository extends JpaRepository<Domain, Long> {
    Optional<Domain> findById(String id);
}
```
